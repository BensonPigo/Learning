graph TB
    subgraph "HelpDefinition Form"
        F1["LoadHelpData"]
        F2["顯示說明內容"]
        F3["使用者編輯"]
        F4["btnSave_Click"]
    end

    subgraph "ApplicationService"
        A1["SaveHelpDefinition"]
        A2["驗證業務規則"]
        A3{"權限檢查"}
        A4["更新Entity"]
    end

    subgraph "Repository"
        R1["Save(entity)"]
        R2["BEGIN TRANSACTION"]
        R3["UPDATE HelpDefinition"]
        R4["UPDATE Department"]
        R5["UPDATE TargetMapping"]
        R6["COMMIT"]
    end

    subgraph "結果處理"
        S1["成功"]
        S2["顯示成功訊息"]
        S3["重新載入資料"]
        E1["失敗"]
        E2["ROLLBACK"]
        E3["顯示錯誤訊息"]
    end

    F1 --> F2
    F2 --> F3
    F3 --> F4
    F4 --> A1
    
    A1 --> A2
    A2 --> A3
    A3 -->|通過| A4
    A3 -->|拒絕| E1
    A4 --> R1
    
    R1 --> R2
    R2 --> R3
    R3 --> R4
    R4 --> R5
    R5 --> R6
    
    R6 --> S1
    S1 --> S2
    S2 --> S3
    
    E1 --> E2
    E2 --> E3

    classDef formStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef appStyle fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef repoStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef successStyle fill:#c8e6c9,stroke:#388e3c,stroke-width:3px
    classDef errorStyle fill:#ffcdd2,stroke:#c62828,stroke-width:3px

    class F1,F2,F3,F4 formStyle
    class A1,A2,A3,A4 appStyle
    class R1,R2,R3,R4,R5,R6 repoStyle
    class S1,S2,S3 successStyle
    class E1,E2,E3 errorStyle
