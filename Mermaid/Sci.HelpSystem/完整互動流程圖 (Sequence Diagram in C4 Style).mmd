sequenceDiagram
    actor User as ğŸ‘¤ ä½¿ç”¨è€…
    participant Form as ğŸ“ WinForm
    participant HM as ğŸ”§ HelpManager
    participant HB as ğŸ”˜ HelpButton
    participant CH as ğŸ›ï¸ ControlHelp
    participant QS as ğŸ” QueryService
    participant HD as ğŸ“‹ HelpDefinition
    participant AS as âš™ï¸ AppService
    participant Repo as ğŸ’¾ Repository
    participant DB as ğŸ—„ï¸ Database

    rect rgb(240, 248, 255)
        Note over User,DB: Phase 1: ç³»çµ±åˆå§‹åŒ–
        Form->>HM: Initialize(pass1ID)
        activate HM
        HM->>HM: æª¢æŸ¥EnableHelpModeé…ç½®
        HM->>HB: new HelpButton(form, pass1ID)
        activate HB
        HM->>Form: æ³¨å…¥HelpButton & Label
        HM->>HB: EnableDragging()
        HM->>Form: è¨»å†Šäº‹ä»¶(ControlAdded, FormClosed)
        deactivate HM
        deactivate HB
    end

    rect rgb(255, 250, 240)
        Note over User,DB: Phase 2: å•Ÿç”¨å¹«åŠ©æ¨¡å¼
        User->>HB: é»æ“ŠæŒ‰éˆ•
        activate HB
        HB->>HB: æª¢æŸ¥EditMode
        HB->>CH: EnableHelpMode(form, this, pass1ID)
        activate CH
        CH->>CH: InitializeStateContainers()
        CH->>QS: GetControlHelpDtos(formName, userId)
        activate QS
        QS->>DB: SELECT (JOIN HelpDefinition tables)
        DB-->>QS: DataTable
        QS->>QS: è½‰æ›ç‚ºList~HelpDefinitionDto~
        QS-->>CH: List~HelpDefinitionDto~
        deactivate QS
        CH->>CH: HighlightControls(éè¿´)
        CH->>Form: ä¿®æ”¹BackColorç‚ºOrange
        CH->>CH: AttachClickEvents(Reflection)
        CH->>Form: Cursor = Help
        CH-->>HB: å®Œæˆ
        deactivate CH
        HB->>HB: UpdateVisualState()
        HB-->>User: é¡¯ç¤ºé«˜äº®æ•ˆæœ
        deactivate HB
    end

    rect rgb(240, 255, 240)
        Note over User,DB: Phase 3: æŸ¥çœ‹èˆ‡ç·¨è¼¯èªªæ˜
        User->>Form: é»æ“Šæ§åˆ¶é …
        Form->>CH: Control_Click(ä»£ç†äº‹ä»¶)
        activate CH
        CH->>CH: ShowHelpText(éè¿´å°‹æ‰¾)
        CH->>HD: new HelpDefinition(formName, controlName, pass1ID)
        activate HD
        HD->>AS: GetHelpDefinition(className, controlName)
        activate AS
        AS->>Repo: GetByControl(className, controlName)
        activate Repo
        Repo->>DB: SELECT (Aggregate Root + Children)
        DB-->>Repo: DataTable
        Repo->>Repo: Hydration (MapToEntity)
        Repo-->>AS: HelpDefinition Entity
        deactivate Repo
        AS-->>HD: HelpDefinition Entity
        deactivate AS
        HD->>HD: LoadHelpData()
        HD-->>User: é¡¯ç¤ºèªªæ˜è¦–çª—
        deactivate HD
        deactivate CH
        
        User->>HD: ç·¨è¼¯èªªæ˜å…§å®¹
        activate HD
        HD->>AS: SaveHelpDefinition(entity)
        activate AS
        AS->>AS: é©—è­‰æ¥­å‹™è¦å‰‡
        AS->>Repo: Save(entity)
        activate Repo
        Repo->>DB: UPDATE HelpDefinition<br/>UPDATE Department<br/>UPDATE TargetMapping
        DB-->>Repo: Success
        Repo-->>AS: true
        deactivate Repo
        AS-->>HD: true
        deactivate AS
        HD-->>User: é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        deactivate HD
    end

    rect rgb(255, 240, 240)
        Note over User,DB: Phase 4: ç¦ç”¨å¹«åŠ©æ¨¡å¼
        User->>HB: å†æ¬¡é»æ“ŠæŒ‰éˆ•
        activate HB
        HB->>CH: DisableHelpMode(form, pass1ID)
        activate CH
        CH->>Form: é‚„åŸBackColor
        CH->>CH: DetachClickEvents(Reflection)
        CH->>CH: ClearFormData()
        CH->>Form: Cursor = Default
        CH-->>HB: å®Œæˆ
        deactivate CH
        HB->>HB: ResetHelpModeState()
        HB-->>User: æ¢å¾©æ­£å¸¸ç‹€æ…‹
        deactivate HB
    end

    rect rgb(245, 245, 245)
        Note over User,DB: Phase 5: æ¸…ç†è³‡æº
        User->>Form: é—œé–‰è¡¨å–®
        Form->>CH: Form_FormClosed_Cleanup
        activate CH
        CH->>CH: æ¸…ç†ConcurrentDictionary
        CH->>CH: ç§»é™¤Formç›¸é—œè³‡æº
        deactivate CH
    end
